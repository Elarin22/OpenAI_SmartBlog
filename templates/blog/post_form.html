{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}ê¸€ ìˆ˜ì •{% else %}ìƒˆ ê¸€ ì‘ì„±{% endif %} - Smart Blog{% endblock %}

{% block content %}
<div class="blog-background">
    <div class="container py-5">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card border-0 shadow-lg blog-card">
                    <div class="card-header gradient-header text-white text-center py-4">
                        <h2 class="fw-bold mb-0">
                            <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %} me-2"></i>
                            {% if form.instance.pk %}ê¸€ ìˆ˜ì •í•˜ê¸°{% else %}ìƒˆ ê¸€ ì‘ì„±í•˜ê¸°{% endif %}
                        </h2>
                        <p class="mb-0 opacity-90">AIì˜ ë„ì›€ì„ ë°›ì•„ ë©‹ì§„ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”</p>
                    </div>
                    
                    <div class="card-body p-4">
                        <form method="post" enctype="multipart/form-data" id="postForm">
                            {% csrf_token %}
                            
                            <div class="row">
                                <!-- ì™¼ìª½ ì˜ì—­: í¼ -->
                                <div class="col-lg-8">
                                    <!-- ì œëª© -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label for="id_title" class="form-label fw-semibold">
                                                <i class="fas fa-heading me-2 text-primary"></i>ì œëª©
                                            </label>
                                            <div>
                                                <button type="button" class="btn btn-outline-primary btn-sm me-1" id="suggestTitleBtn">
                                                    <i class="fas fa-lightbulb me-1"></i>AI ì œëª© ì¶”ì²œ
                                                </button>
                                            </div>
                                        </div>
                                        <input type="text" class="form-control form-control-lg" 
                                               id="id_title" name="title" 
                                               value="{{ form.title.value|default:'' }}"
                                               placeholder="ë§¤ë ¥ì ì¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                                        
                                        <!-- ì œëª© ì¶”ì²œ ê²°ê³¼ -->
                                        <div id="titleSuggestions" class="mt-2" style="display: none;">
                                            <small class="text-muted">ì¶”ì²œ ì œëª©ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”:</small>
                                            <div id="titleList" class="mt-1"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- ì¹´í…Œê³ ë¦¬ -->
                                    <div class="mb-4">
                                        <label for="id_category" class="form-label fw-semibold">
                                            <i class="fas fa-folder me-2 text-primary"></i>ì¹´í…Œê³ ë¦¬
                                        </label>
                                        <select class="form-select form-select-lg" id="id_category" name="category">
                                            <option value="tech" {% if form.category.value == 'tech' %}selected{% endif %}>ê¸°ìˆ </option>
                                            <option value="life" {% if form.category.value == 'life' %}selected{% endif %}>ì¼ìƒ</option>
                                            <option value="review" {% if form.category.value == 'review' %}selected{% endif %}>ë¦¬ë·°</option>
                                            <option value="etc" {% if form.category.value == 'etc' %}selected{% endif %}>ê¸°íƒ€</option>
                                        </select>
                                    </div>
                                    
                                    <!-- ì´ë¯¸ì§€ -->
                                    <div class="mb-4">
                                        <label for="id_image" class="form-label fw-semibold">
                                            <i class="fas fa-image me-2 text-primary"></i>ëŒ€í‘œ ì´ë¯¸ì§€
                                        </label>
                                        <input type="file" class="form-control form-control-lg" 
                                               id="id_image" name="image" accept="image/*">
                                    </div>
                                    
                                    <!-- ë³¸ë¬¸ -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label for="id_content" class="form-label fw-semibold">
                                                <i class="fas fa-edit me-2 text-primary"></i>ë³¸ë¬¸
                                            </label>
                                            <div>
                                                <button type="button" class="btn btn-outline-success btn-sm me-1" id="autoCompleteBtn">
                                                    <i class="fas fa-magic me-1"></i>AI ìë™ì™„ì„±
                                                </button>
                                                <button type="button" class="btn btn-outline-info btn-sm" id="generateSummaryBtn">
                                                    <i class="fas fa-compress-alt me-1"></i>AI ìš”ì•½
                                                </button>
                                            </div>
                                        </div>
                                        <textarea class="form-control" 
                                                  id="id_content" name="content" 
                                                  rows="15" 
                                                  placeholder="ì—¬ê¸°ì— ê¸€ì„ ì‘ì„±í•˜ì„¸ìš”. AIê°€ ë„ì™€ë“œë¦´ê²Œìš”!" 
                                                  required>{{ form.content.value|default:'' }}</textarea>
                                    </div>
                                    
                                    <!-- íƒœê·¸ -->
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <label class="form-label fw-semibold">
                                                <i class="fas fa-tags me-2 text-primary"></i>íƒœê·¸
                                            </label>
                                            <button type="button" class="btn btn-outline-warning btn-sm" id="suggestTagsBtn">
                                                <i class="fas fa-tag me-1"></i>AI íƒœê·¸ ì¶”ì²œ
                                            </button>
                                        </div>
                                        
                                        <!-- Hidden input for tags -->
                                        <input type="hidden" id="selectedTagIds" name="tags_data" value="">
                                        
                                        <!-- í˜„ì¬ ì„ íƒëœ íƒœê·¸ í‘œì‹œ -->
                                        <div class="mt-2">
                                            <small class="text-muted">ì„ íƒëœ íƒœê·¸:</small>
                                            <div id="selectedTags" class="mt-1">
                                                <!-- ê¸°ì¡´ íƒœê·¸ë“¤ í‘œì‹œ (ìˆ˜ì • ì‹œ) -->
                                                {% if form.instance.pk and form.instance.tags.all %}
                                                    {% for tag in form.instance.tags.all %}
                                                        <span class="badge bg-primary me-1 mb-1 selected-tag" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}">
                                                            #{{ tag.name }}
                                                            <i class="fas fa-times ms-1 remove-tag" style="cursor: pointer;"></i>
                                                        </span>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- íƒœê·¸ ì¶”ì²œ ê²°ê³¼ -->
                                        <div id="tagSuggestions" class="mt-2" style="display: none;">
                                            <small class="text-muted">ì¶”ì²œ íƒœê·¸ (í´ë¦­í•˜ì—¬ ì„ íƒ):</small>
                                            <div id="tagList" class="mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ì˜¤ë¥¸ìª½ ì˜ì—­: AI ê¸°ëŠ¥ íŒ¨ë„ -->
                                <div class="col-lg-4">
                                    <div class="ai-panel">
                                        <h5 class="fw-bold mb-3">
                                            <i class="fas fa-robot me-2 text-primary"></i>AI ë„ìš°ë¯¸
                                        </h5>
                                        
                                        <!-- AI ì‚¬ìš©ëŸ‰ í‘œì‹œ -->
                                        <div class="ai-usage-card mb-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>AI ì‚¬ìš©ëŸ‰</span>
                                                <span class="badge bg-primary">{{ user.ai_usage_count|default:0 }}íšŒ</span>
                                            </div>
                                        </div>
                                        
                                        <!-- ìš”ì•½ ê²°ê³¼ í‘œì‹œ -->
                                        <div id="summaryResult" class="mt-3" style="display: none;">
                                            <h6 class="fw-bold">AI ìš”ì•½</h6>
                                            <div class="summary-box p-3 border rounded">
                                                <div id="summaryText"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ë²„íŠ¼ -->
                            <div class="d-flex gap-3 justify-content-end mt-4">
                                <a href="{% url 'post_list' %}" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>ì·¨ì†Œ
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    {% if form.instance.pk %}ìˆ˜ì • ì™„ë£Œ{% else %}ê¸€ ë°œí–‰{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.blog-background {
    background: linear-gradient(135deg, #ffffff 0%, #fce7f3 25%, #f9a8d4 50%, #fce7f3 75%, #ffffff 100%);
    min-height: 100vh;
}

.blog-card {
    border-radius: 20px;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.95);
    overflow: hidden;
}

.gradient-header {
    background: linear-gradient(135deg, #ffffff 0%, #fce7f3 25%, #f9a8d4 50%, #fce7f3 75%, #ffffff 100%) !important;
    color: #374151 !important;
    border: none;
    position: relative;
}

.gradient-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.9) 0%, 
        rgba(252, 231, 243, 0.8) 25%, 
        rgba(249, 168, 212, 0.7) 50%, 
        rgba(252, 231, 243, 0.8) 75%, 
        rgba(255, 255, 255, 0.9) 100%);
    z-index: 1;
}

.gradient-header h2,
.gradient-header p {
    position: relative;
    z-index: 2;
    color: #374151 !important;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

.gradient-header i {
    color: #ec4899 !important;
}

.ai-panel {
    background: rgba(249, 168, 212, 0.1);
    border-radius: 15px;
    padding: 1.5rem;
}

.ai-usage-card {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    padding: 1rem;
}

.title-suggestion-item, .tag-suggestion-item {
    display: inline-block;
    background: rgba(236, 72, 153, 0.1);
    border: 1px solid rgba(236, 72, 153, 0.3);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    margin: 0.25rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.title-suggestion-item:hover, .tag-suggestion-item:hover {
    background: rgba(236, 72, 153, 0.2);
    transform: translateY(-1px);
}

.selected-tag {
    position: relative;
}

.remove-tag:hover {
    color: #ff6b6b !important;
    transform: scale(1.2);
}

.summary-box {
    background: rgba(139, 92, 246, 0.1);
    border-color: rgba(139, 92, 246, 0.3) !important;
}

.btn-primary {
    background: linear-gradient(135deg, #ec4899, #f9a8d4);
    border: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #db2777, #ec4899);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
}

.form-label .text-primary {
    color: #ec4899 !important;
}

.ai-panel .text-primary {
    color: #ec4899 !important;
}

.badge.bg-primary {
    background: linear-gradient(135deg, #ec4899, #f9a8d4) !important;
}

.ai-usage-card .badge.bg-primary {
    background: linear-gradient(135deg, #ec4899, #f9a8d4) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    
    let selectedTags = new Set();
    
    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }
    
    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
    function showSuccessMessage(message) {
        const toast = document.createElement('div');
        toast.innerHTML = `
            <div style="
                position: fixed; 
                top: 20px; 
                right: 20px; 
                z-index: 9999; 
                background: #28a745; 
                color: white; 
                padding: 1rem 1.5rem; 
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            ">
                âœ… ${message}
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // ì œëª© ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
    function displayTitleSuggestions(titles) {
        const container = document.getElementById('titleSuggestions');
        const listContainer = document.getElementById('titleList');
        
        if (!container || !listContainer) {
            alert('ì¶”ì²œ ì œëª©:\n' + titles.join('\n\ní´ë¦­í•˜ë ¤ë©´ ë‹¤ì‹œ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.'));
            return;
        }
        
        listContainer.innerHTML = '';
        
        titles.forEach(title => {
            const item = document.createElement('div');
            item.className = 'title-suggestion-item';
            item.textContent = title;
            item.style.cssText = `
                background: rgba(236, 72, 153, 0.1);
                border: 1px solid rgba(236, 72, 153, 0.3);
                border-radius: 8px;
                padding: 0.5rem 1rem;
                margin: 0.25rem;
                cursor: pointer;
                transition: all 0.3s ease;
                display: inline-block;
            `;
            
            item.addEventListener('click', function() {
                document.getElementById('id_title').value = title;
                container.style.display = 'none';
                showSuccessMessage('ì œëª©ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
            
            item.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(236, 72, 153, 0.2)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.background = 'rgba(236, 72, 153, 0.1)';
            });
            
            listContainer.appendChild(item);
        });
        
        container.style.display = 'block';
    }
    
    // íƒœê·¸ ì¶”ì²œ ê²°ê³¼ í‘œì‹œ (í–¥ìƒëœ ë²„ì „)
    function displayTagSuggestions(tags) {
        const container = document.getElementById('tagSuggestions');
        const listContainer = document.getElementById('tagList');
        
        if (!container || !listContainer) {
            alert('ì¶”ì²œ íƒœê·¸:\n#' + tags.join('\n#'));
            return;
        }
        
        listContainer.innerHTML = '';
        
        tags.forEach(tagName => {
            const item = document.createElement('span');
            item.className = 'tag-suggestion-item';
            item.textContent = '#' + tagName;
            item.dataset.tagName = tagName; // íƒœê·¸ ì´ë¦„ì„ data ì†ì„±ìœ¼ë¡œ ì €ì¥
            item.style.cssText = `
                background: rgba(236, 72, 153, 0.1);
                border: 1px solid rgba(236, 72, 153, 0.3);
                border-radius: 8px;
                padding: 0.5rem 1rem;
                margin: 0.25rem;
                cursor: pointer;
                transition: all 0.3s ease;
                display: inline-block;
            `;
            
            // ì´ë¯¸ ì„ íƒëœ íƒœê·¸ì¸ì§€ í™•ì¸
            const isAlreadySelected = Array.from(selectedTags).some(tagStr => {
                const tagData = JSON.parse(tagStr);
                return tagData.name === tagName;
            });
            
            if (isAlreadySelected) {
                item.style.opacity = '0.5';
                item.style.pointerEvents = 'none';
                item.style.background = 'rgba(156, 163, 175, 0.1)';
            } else {
                // í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
                item.addEventListener('mouseenter', function() {
                    if (this.style.pointerEvents !== 'none') {
                        this.style.background = 'rgba(236, 72, 153, 0.2)';
                    }
                });
                
                item.addEventListener('mouseleave', function() {
                    if (this.style.pointerEvents !== 'none') {
                        this.style.background = 'rgba(236, 72, 153, 0.1)';
                    }
                });
            }
            
            item.addEventListener('click', function() {
                if (this.style.pointerEvents !== 'none') {
                    addTag(tagName);
                    // ì´ ì•„ì´í…œì„ ë¹„í™œì„±í™”
                    this.style.opacity = '0.5';
                    this.style.pointerEvents = 'none';
                    this.style.background = 'rgba(156, 163, 175, 0.1)';
                    showSuccessMessage('íƒœê·¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            });
            
            listContainer.appendChild(item);
        });
        
        container.style.display = 'block';
    }
    
    // íƒœê·¸ ì¶”ê°€ í•¨ìˆ˜ (í–¥ìƒëœ ë²„ì „)
    function addTag(tagName) {
        const tagData = {
            id: null,
            name: tagName
        };
        
        const tagKey = JSON.stringify(tagData);
        if (selectedTags.has(tagKey)) return;
        
        selectedTags.add(tagKey);
        
        const selectedTagsContainer = document.getElementById('selectedTags');
        if (selectedTagsContainer) {
            const tagElement = document.createElement('span');
            tagElement.className = 'badge bg-primary me-1 mb-1 selected-tag';
            tagElement.dataset.tagName = tagName; // íƒœê·¸ ì´ë¦„ ì €ì¥
            tagElement.innerHTML = `
                #${tagName}
                <i class="fas fa-times ms-1 remove-tag" style="cursor: pointer;"></i>
            `;
            
            // íƒœê·¸ ì œê±° ì´ë²¤íŠ¸
            tagElement.querySelector('.remove-tag').addEventListener('click', function() {
                selectedTags.delete(tagKey);
                tagElement.remove();
                updateHiddenTagInput();
                
                // ì¶”ì²œ ëª©ë¡ì—ì„œ í•´ë‹¹ íƒœê·¸ë¥¼ ë‹¤ì‹œ í™œì„±í™”
                reactivateTagInSuggestions(tagName);
                
                showSuccessMessage('íƒœê·¸ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
            
            selectedTagsContainer.appendChild(tagElement);
            updateHiddenTagInput();
        }
    }
    
    // íƒœê·¸ ì¶”ì²œ ëª©ë¡ì—ì„œ íƒœê·¸ ë‹¤ì‹œ í™œì„±í™”
    function reactivateTagInSuggestions(tagName) {
        const suggestionItems = document.querySelectorAll('.tag-suggestion-item');
        suggestionItems.forEach(item => {
            if (item.dataset.tagName === tagName) {
                item.style.opacity = '1';
                item.style.pointerEvents = 'auto';
                item.style.background = 'rgba(236, 72, 153, 0.1)';
                
                // í˜¸ë²„ íš¨ê³¼ë„ ë‹¤ì‹œ ì¶”ê°€
                item.onmouseenter = function() {
                    if (this.style.pointerEvents !== 'none') {
                        this.style.background = 'rgba(236, 72, 153, 0.2)';
                    }
                };
                
                item.onmouseleave = function() {
                    if (this.style.pointerEvents !== 'none') {
                        this.style.background = 'rgba(236, 72, 153, 0.1)';
                    }
                };
            }
        });
    }
    
    // ìˆ¨ê²¨ì§„ íƒœê·¸ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    function updateHiddenTagInput() {
        const hiddenInput = document.getElementById('selectedTagIds');
        if (hiddenInput) {
            const tagData = Array.from(selectedTags).map(tagStr => JSON.parse(tagStr));
            hiddenInput.value = JSON.stringify(tagData);
        }
    }
    
    // ì œëª© ì¶”ì²œ ë²„íŠ¼
    const titleBtn = document.getElementById('suggestTitleBtn');
    if (titleBtn) {
        titleBtn.addEventListener('click', function() {
            const content = document.getElementById('id_content').value.trim();
            
            if (!content || content.length < 20) {
                alert(`ë” ë§ì€ ë‚´ìš©ì„ ì‘ì„±í•œ í›„ ì œëª©ì„ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”. (í˜„ì¬: ${content.length}ì, ìµœì†Œ: 20ì)`);
                return;
            }
            
            titleBtn.disabled = true;
            titleBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>AI ì‘ì—…ì¤‘...';
            
            fetch('/blog/ai/suggest-title/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    displayTitleSuggestions(data.titles);
                    showSuccessMessage('AIê°€ ì œëª©ì„ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤! ğŸ’¡');
                } else {
                    alert('ì œëª© ì¶”ì²œ ì‹¤íŒ¨: ' + (data?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                alert('ì œëª© ì¶”ì²œ ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            })
            .finally(() => {
                titleBtn.disabled = false;
                titleBtn.innerHTML = '<i class="fas fa-lightbulb me-1"></i>AI ì œëª© ì¶”ì²œ';
            });
        });
    }
    
    // ìë™ì™„ì„± ë²„íŠ¼
    const autoBtn = document.getElementById('autoCompleteBtn');
    if (autoBtn) {
        autoBtn.addEventListener('click', function() {
            const contentField = document.getElementById('id_content');
            const content = contentField.value.trim();
            
            if (!content || content.length < 30) {
                alert(`ë” ë§ì€ ë‚´ìš©ì„ ì‘ì„±í•œ í›„ ìë™ì™„ì„±ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”. (í˜„ì¬: ${content.length}ì, ìµœì†Œ: 30ì)`);
                return;
            }
            
            autoBtn.disabled = true;
            autoBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>AI ì‘ì—…ì¤‘...';
            
            fetch('/blog/ai/complete-content/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    content: content,
                    style: 'friendly'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    const newContent = contentField.value + '\n\n' + data.completion;
                    contentField.value = newContent;
                    contentField.focus();
                    contentField.setSelectionRange(newContent.length, newContent.length);
                    showSuccessMessage('AIê°€ ê¸€ì„ ì´ì–´ì„œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤! ğŸ“');
                } else {
                    alert('ìë™ì™„ì„± ì‹¤íŒ¨: ' + (data?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                alert('ìë™ì™„ì„± ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            })
            .finally(() => {
                autoBtn.disabled = false;
                autoBtn.innerHTML = '<i class="fas fa-magic me-1"></i>AI ìë™ì™„ì„±';
            });
        });
    }
    
    // íƒœê·¸ ì¶”ì²œ ë²„íŠ¼
    const tagBtn = document.getElementById('suggestTagsBtn');
    if (tagBtn) {
        tagBtn.addEventListener('click', function() {
            const title = document.getElementById('id_title').value.trim();
            const content = document.getElementById('id_content').value.trim();
            
            if (!title && !content) {
                alert('ì œëª©ì´ë‚˜ ë‚´ìš©ì„ ì‘ì„±í•œ í›„ íƒœê·¸ë¥¼ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”.');
                return;
            }
            
            tagBtn.disabled = true;
            tagBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>AI ì‘ì—…ì¤‘...';
            
            fetch('/blog/ai/suggest-tags/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    title: title,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    displayTagSuggestions(data.tags);
                    showSuccessMessage('AIê°€ íƒœê·¸ë¥¼ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤! ğŸ·ï¸');
                } else {
                    alert('íƒœê·¸ ì¶”ì²œ ì‹¤íŒ¨: ' + (data?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                alert('íƒœê·¸ ì¶”ì²œ ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            })
            .finally(() => {
                tagBtn.disabled = false;
                tagBtn.innerHTML = '<i class="fas fa-tag me-1"></i>AI íƒœê·¸ ì¶”ì²œ';
            });
        });
    }
    
    // ìš”ì•½ ìƒì„± ë²„íŠ¼
    const summaryBtn = document.getElementById('generateSummaryBtn');
    if (summaryBtn) {
        summaryBtn.addEventListener('click', function() {
            const content = document.getElementById('id_content').value.trim();
            
            if (!content || content.length < 200) {
                alert(`ìš”ì•½í•˜ê¸°ì—ëŠ” ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. (í˜„ì¬: ${content.length}ì, ìµœì†Œ: 200ì)`);
                return;
            }
            
            summaryBtn.disabled = true;
            summaryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>AI ì‘ì—…ì¤‘...';
            
            fetch('/blog/ai/generate-summary/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    const summaryTextElement = document.getElementById('summaryText');
                    const summaryResultElement = document.getElementById('summaryResult');
                    
                    if (summaryTextElement && summaryResultElement) {
                        summaryTextElement.textContent = data.summary;
                        summaryResultElement.style.display = 'block';
                    } else {
                        alert('AI ìš”ì•½ ê²°ê³¼:\n\n' + data.summary);
                    }
                    showSuccessMessage('AIê°€ ê¸€ì„ ìš”ì•½í–ˆìŠµë‹ˆë‹¤! ğŸ“‹');
                } else {
                    alert('ìš”ì•½ ìƒì„± ì‹¤íŒ¨: ' + (data?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                alert('ìš”ì•½ ìƒì„± ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            })
            .finally(() => {
                summaryBtn.disabled = false;
                summaryBtn.innerHTML = '<i class="fas fa-compress-alt me-1"></i>AI ìš”ì•½';
            });
        });
    }
    
    // ê¸°ì¡´ íƒœê·¸ ë¡œë“œ (ìˆ˜ì • ì‹œ)
    document.querySelectorAll('.selected-tag').forEach(tag => {
        const tagId = tag.dataset.tagId;
        const tagName = tag.dataset.tagName;
        if (tagId && tagName) {
            selectedTags.add(JSON.stringify({id: tagId, name: tagName}));
        }
    });
    
    updateHiddenTagInput();
    
    console.log('ëª¨ë“  AI ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡ ì™„ë£Œ');
});
</script>
{% endblock %}